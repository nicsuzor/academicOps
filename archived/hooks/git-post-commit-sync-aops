#!/usr/bin/env bash
# Git post-commit hook to auto-sync aOps bundle
# Installed by sync_web_bundle.py

# Only run in full environments (where $AOPS is set)
if [ -z "$AOPS" ]; then
    exit 0
fi

# Only run if .aops-bundle marker exists
if [ ! -f ".claude/.aops-bundle" ]; then
    exit 0
fi

# Get the aOps root from marker file or use $AOPS
AOPS_ROOT="${AOPS}"
SYNC_SCRIPT="${AOPS_ROOT}/scripts/sync_web_bundle.py"

# Check if sync script exists
if [ ! -f "$SYNC_SCRIPT" ]; then
    echo "Warning: aOps sync script not found at $SYNC_SCRIPT" >&2
    exit 0
fi

# Run sync (silently unless there's an error)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
if python3 "$SYNC_SCRIPT" "$PROJECT_ROOT" --force >/dev/null 2>&1; then
    # Check if .claude/ has changes
    if git diff --quiet HEAD .claude/; then
        # No changes
        exit 0
    fi

    # Stage and commit changes
    git add .claude/
    git commit --no-verify -m "chore: auto-sync aOps bundle

Updated from academicOps framework

Co-authored-by: aOps sync hook <noreply@academicops.dev>" >/dev/null

    echo "aOps bundle updated and committed"
else
    echo "Warning: aOps bundle sync failed" >&2
    exit 0  # Don't fail the commit
fi
