---
name: flow
title: Execution Flow
category: state
type: state
description: Where the framework injects control during a Claude Code session.
generated_by: audit skill
generated_from: hooks/router.py HOOK_REGISTRY
---

> **Generated by audit skill** - Do not edit manually.

# academicOps Execution Flow

Where the framework injects control during a Claude Code session.

**Spec**: [[specs/execution-flow-spec]]

## Complete Execution Flow

Every prompt goes through this flow. The **Main Agent** runs as a continuous vertical spine (left column). **Hooks** and **Subagents** appear alongside when invoked (right columns), with arrows showing interaction points.

```mermaid
%%{init: {
  'theme': 'base',
  'flowchart': { 'nodeSpacing': 30, 'rankSpacing': 40 }
}}%%
flowchart TB
    %% Color definitions
    classDef main fill:#e3f2fd,stroke:#1565c0,color:#0d47a1
    classDef hook fill:#ffebee,stroke:#c62828,color:#b71c1c
    classDef subagent fill:#f3e5f5,stroke:#7b1fa2,color:#4a148c
    classDef tool fill:#eceff1,stroke:#607d8b,color:#37474f
    classDef storage fill:#e0f7fa,stroke:#00838f,color:#006064
    classDef planned fill:#fff3e0,stroke:#ef6c00,color:#e65100
    classDef gate fill:#fff9c4,stroke:#f9a825,color:#f57f17

    subgraph MAIN["Main Agent"]
        direction TB
        M0([Session Start])
        M1[Receive context injection]
        M2[User prompt arrives]
        M3[Receive hydration instruction]
        M4[Spawn hydrator subagent]
        M5[Receive workflow guidance]
        M6{Plan mode?}
        M7[Define acceptance criteria]
        M8[Spawn critic for review]
        M9[Create TodoWrite + gate]
        M10[Mark todo in_progress]
        M11[Call tool]
        M12[Receive hook feedback]
        M13{Checkpoint?}
        M14[Continue work]
        M15[Commit + push]
        M16{QA needed?}
        M17[Final cleanup]
        M18([Session End])

        M0 --> M1 --> M2 --> M3 --> M4 --> M5 --> M6
        M6 -->|Yes| M7 --> M8 --> M9 --> M10
        M6 -->|No| M10
        M10 --> M11 --> M12 --> M13
        M13 -->|No| M14 --> M11
        M13 -->|Yes| M15 --> M16
        M16 -->|Yes| M17
        M16 -->|No| M17
        M17 --> M18
    end

    subgraph HOOKS["Hooks"]
        direction TB
        H1["SessionStart<br/>─────────────<br/>sessionstart_load_axioms.py"]
        H2["UserPromptSubmit<br/>─────────────<br/>user_prompt_submit.py"]
        H3["PreToolUse<br/>─────────────<br/>policy_enforcer.py<br/>criteria_gate.py"]
        H4["PostToolUse<br/>─────────────<br/>autocommit_state.py<br/>fail_fast_watchdog.py<br/>custodiet_gate.py"]
        H5["Stop<br/>─────────────<br/>request_scribe.py<br/>session_reflect.py"]

        H1 ~~~ H2 ~~~ H3 ~~~ H4 ~~~ H5
    end

    subgraph AGENTS["Subagents"]
        direction TB
        A1["prompt-hydrator<br/>(haiku)<br/>─────────────<br/>Workflow selection<br/>Skill matching<br/>Guardrail injection"]
        A2["critic<br/>─────────────<br/>Plan review<br/>Criteria validation"]
        A3["custodiet<br/>─────────────<br/>Ultra vires check<br/>Scope drift detection"]
        A4["remember<br/>(haiku)<br/>─────────────<br/>Memory persistence"]

        A1 ~~~ A2 ~~~ A3 ~~~ A4
    end

    %% Cross-lane connections: Main ↔ Hooks
    M0 --> H1
    H1 -->|"AXIOMS, HEURISTICS,<br/>FRAMEWORK, CORE"| M1
    M2 --> H2
    H2 -->|"'Spawn hydrator'"| M3
    M11 --> H3
    H3 -->|"allow/block"| M11
    M11 --> H4
    H4 -->|"context injection"| M12
    M17 --> H5

    %% Cross-lane connections: Main ↔ Subagents
    M4 --> A1
    A1 -->|"workflow + skill + guardrails"| M5
    M8 --> A2
    A2 -->|"approved/rejected"| M9
    H4 -.->|"~7 tools"| A3
    A3 -.->|"compliance check"| M12
    H5 --> A4

    %% Styling
    class M0,M1,M2,M3,M4,M5,M6,M7,M8,M9,M10,M11,M12,M13,M14,M15,M16,M17,M18 main
    class H1,H2,H3,H4,H5 hook
    class A1,A2,A3,A4 subagent

    %% Subgraph styling
    style MAIN fill:#e8f5e9,stroke:#2e7d32
    style HOOKS fill:#ffebee,stroke:#c62828
    style AGENTS fill:#f3e5f5,stroke:#7b1fa2
```

## Flow Legend

| Color           | Meaning                                  |
| --------------- | ---------------------------------------- |
| Green           | Entry/success points                     |
| Blue            | User actions                             |
| Purple          | Skill invocations                        |
| Red             | Hook enforcement (can block)             |
| Orange + dashed | Planned/in-progress (not yet enforced)   |
| Gray            | Tool execution                           |
| Cyan            | External storage (memory server, GitHub) |

## Workflow Selection (from WORKFLOWS.md)

The prompt-hydrator selects workflow based on task signals:

| Task Signal                                 | Workflow     | Skill       | Guardrails                   |
| ------------------------------------------- | ------------ | ----------- | ---------------------------- |
| Framework changes (skills/, hooks/, AXIOMS) | plan-mode    | framework   | `plan_mode`, `critic_review` |
| New functionality, "add", "create"          | tdd          | feature-dev | `require_acceptance_test`    |
| Bug reports, "doesn't work"                 | verify-first | -           | `quote_errors_exactly`       |
| Questions, explanations                     | answer-only  | -           | `answer_only`                |
| Single-step clear scope                     | direct       | -           | `verify_before_complete`     |

## Hook Enforcement Details

### PreToolUse Hooks (can block)

| Hook               | Blocks                                                                       | Enforces                                      |
| ------------------ | ---------------------------------------------------------------------------- | --------------------------------------------- |
| policy_enforcer.py | `git reset --hard`, `push --force`, `*-GUIDE.md`, `.md` > 200 prose lines    | A#15 Trust Version Control, MINIMAL principle |
| criteria_gate.py   | Edit/Write/Bash until criteria defined + critic reviewed + TodoWrite created | A#22 Acceptance Criteria, A#23 Plan-First     |

### PostToolUse Hooks (inject context)

| Hook                  | Triggers On         | Action                                                                                 |
| --------------------- | ------------------- | -------------------------------------------------------------------------------------- |
| autocommit_state.py   | Write to data/      | Auto-commit to prevent data loss                                                       |
| fail_fast_watchdog.py | Error patterns      | Inject fail-fast reminder                                                              |
| custodiet_gate.py     | Every ~7 tool calls | Spawn custodiet agent for ultra vires detection; random reminders (30%) between checks |
| request_scribe.py     | TodoWrite           | Memory documentation reminder                                                          |

### Stop Hooks (cleanup)

| Hook               | Triggers    | Chain                                            |
| ------------------ | ----------- | ------------------------------------------------ |
| request_scribe.py  | Session end | -> remember skill -> $ACA_DATA + memory server   |
| session_reflect.py | Session end | -> session-insights -> daily note + GitHub Issue |

## Key Principles

1. **Hooks enforce axioms** - PreToolUse blocks violations before they happen
2. **Skills provide context** - Domain skills load relevant conventions
3. **Criteria are LOCKED** - Once defined in planning, cannot be weakened
4. **CHECKPOINTs require evidence** - Can't mark complete without proof
5. **Memory persists knowledge** - Stop hooks ensure learnings captured

### Planned Features (Orange in diagram)

Features shown with dashed lines are in development:

| Feature               | Status                | Enforcement                            |
| --------------------- | --------------------- | -------------------------------------- |
| Scope drift detection | Building in custodiet | Will compare TodoWrite to actual edits |
| Thrashing detection   | Building in custodiet | Count edits per file in session        |
| Automatic HALT        | Planned               | Will exit 2 from hook to block         |

Currently these rely on prompt-level guidance + periodic custodiet checks.

## Hook Registry

> **Generated from hooks/router.py HOOK_REGISTRY** - Update router.py to change hooks.

| Event                 | Script                      | Purpose                                                  |
| --------------------- | --------------------------- | -------------------------------------------------------- |
| SessionStart          | session_env_setup.sh        | Environment setup                                        |
| SessionStart          | terminal_title.py           | Set terminal title                                       |
| SessionStart          | sessionstart_load_axioms.py | Load AXIOMS, HEURISTICS, FRAMEWORK, CORE                 |
| SessionStart          | unified_logger.py           | Event logging                                            |
| UserPromptSubmit      | user_prompt_submit.py       | Trigger prompt hydration                                 |
| UserPromptSubmit      | unified_logger.py           | Event logging                                            |
| PreToolUse            | policy_enforcer.py          | Block destructive operations                             |
| PreToolUse            | criteria_gate.py            | Enforce /do Phase 1                                      |
| PreToolUse            | unified_logger.py           | Event logging                                            |
| PostToolUse           | unified_logger.py           | Event logging                                            |
| PostToolUse           | autocommit_state.py         | Auto-commit data/                                        |
| PostToolUse           | fail_fast_watchdog.py       | Detect errors                                            |
| PostToolUse           | custodiet_gate.py           | Ultra vires detection (~7 tool calls) + random reminders |
| PostToolUse:TodoWrite | request_scribe.py           | Memory documentation reminder                            |
| SubagentStop          | unified_logger.py           | Event logging                                            |
| Stop                  | unified_logger.py           | Event logging                                            |
| Stop                  | request_scribe.py           | Memory reminder                                          |
| Stop                  | session_reflect.py          | Reflection prompt                                        |

**Exit codes**: PreToolUse `0`=allow, `2`=block. PostToolUse `0`=success.

## Quick Capture

`/q` saves a task for later; `/do` executes it.

```mermaid
flowchart LR
    U1[/"/q [task]"/] --> T1[("tasks/inbox/")] -.->|later| D1[/"/do [task]"/]

    style U1 fill:#2196f3,color:#fff
    style T1 fill:#9e9e9e,color:#fff
    style D1 fill:#ff9800,color:#fff
```
