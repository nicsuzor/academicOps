<!-- AUTO-GENERATED by bot/scripts/project_sync.py -->
<!-- Last updated: 2025-10-04T00:00:00Z -->
<!-- DO NOT EDIT MANUALLY - Changes will be overwritten -->

# Cross-Cutting Concerns: Dependency Graph and Change Protocols

This document defines how changes in one project affect others and what protocols agents must follow.

## Dependency Chains

### buttermilk → [zotmcp, osbchatmcp, automod, mediamarkets]

**Affects**: 4 dependent projects **Change Impact**: CRITICAL - coordinated testing required

#### Change Types and Protocols

##### 1. API Breaking Changes

**Detection**: Changes to public interfaces, function signatures, core abstractions **Action**: `HALT` - Requires user approval and coordination **Reason**: Simultaneous updates needed across 4 projects

**Process**:

1. Agent MUST halt and report proposed change
2. Create GitHub issue describing:
   - What API is changing
   - Why it's necessary
   - Impact on each dependent project
3. Tag issue with `breaking-change` and `coordination-required`
4. Wait for user approval and coordination plan

**Examples**:

- Changing `Agent` base class interface
- Modifying `Flow` execution API
- Altering configuration schema
- Changing storage/retrieval interfaces

##### 2. API Compatible Changes

**Detection**: New features, internal refactoring, backward-compatible additions **Action**: `TEST_DEPENDENTS` - Proceed with comprehensive testing **Reason**: Should work but must verify

**Process**:

1. Make changes to buttermilk
2. Run buttermilk test suite: `pytest`
3. Run ALL dependent project tests:
   ```bash
   # zotmcp
   cd projects/zotmcp && pytest

   # osbchatmcp
   cd projects/osbchatmcp && pytest

   # automod
   cd projects/automod.cc && pytest tests/integration/buttermilk_*.py

   # mediamarkets
   cd projects/mediamarkets && python -m buttermilk.scripts.validate_scrapers
   ```
4. If ANY test fails: HALT and report
5. If all tests pass: Commit with message referencing tested dependents
6. Update `docs/projects/buttermilk.md` recent activity

**Examples**:

- Adding new agent types
- Adding new configuration options
- Internal performance improvements
- Bug fixes to existing functionality

##### 3. Internal Only Changes

**Detection**: Implementation details, private methods, documentation **Action**: `PROCEED` - Normal development workflow **Reason**: No external API surface affected

**Process**:

1. Make changes
2. Run buttermilk tests: `pytest`
3. Commit normally
4. Monitor for unexpected issues in dependents

**Examples**:

- Refactoring internal utilities
- Updating docstrings
- Improving error messages
- Test suite improvements

### Data Architecture Changes

#### BigQuery Schema Changes

**Affects**: `[automod, mediamarkets, tja]` **Action**: `UPDATE_DBT_FIRST`

**Protocol**:

1. Changes to BigQuery schema MUST update dbt models first
2. Then update consuming code (dashboards, analysis scripts)
3. Never modify BigQuery data manually

**Example Flow**:

```
1. Add column to BigQuery table
2. Update dbt staging model to include new column
3. Update dbt mart models that consume it
4. Run dbt tests: dbt test
5. Update Streamlit dashboards
6. Update analysis scripts in papers/
```

**Affected Tables**:

- `prosocial-443205.testing.flows` (automod predictions)
- `dmrc-platforms.mediamarkets.*` (streaming availability)

#### dbt Model Changes

**Affects**: `[automod_dashboard, mediamarkets_analysis, tja_paper]` **Action**: `VERSION_AND_DOCUMENT`

**Protocol**:

1. Version models using dbt versioning
2. Update `schema.yml` documentation
3. Run `dbt test` to validate
4. Update dependent analyses/dashboards
5. Document changes in project changelog

**Critical Models**:

- `automod`: `fct_judge_predictions`, `fct_synth_predictions`, `fct_scores`
- `mediamarkets`: `fct_availability`, `dim_titles`
- `tja`: `tja_judge_comparison`, experiment models

### Deployment Architecture Changes

#### Docker Architecture Pattern

**Affected**: `[zotmcp, osbchatmcp, automod]` **Action**: `KEEP_ALIGNED` **Reason**: Shared architecture for consistency

**Standard Pattern** (established Oct 2025):

- Runtime: Standalone service + embedded database
- No GCP credentials needed at runtime
- Build pipeline: Uses buttermilk + GCP for data generation
- Testing: pytest suite for both local and Docker

**Protocol When Changing**:

1. Changes to Docker architecture in one project should be evaluated for others
2. Keep Dockerfiles structurally similar
3. Document divergence if intentional
4. Update all three if changing fundamental pattern

**Examples**:

- Base image changes (consider for all)
- Multi-stage build optimization (share across projects)
- Runtime dependency changes (evaluate impact)

#### MCP Protocol Changes

**Affected**: `[zotmcp, osbchatmcp]` **Action**: `MAINTAIN_COMPATIBILITY` **Reason**: Both are MCP servers, protocol must be consistent

**Protocol**:

1. Changes to MCP tool interfaces must maintain backward compatibility
2. Both servers should support same MCP version
3. Test both servers after protocol changes
4. Document any divergence in tool capabilities

**Critical Interfaces**:

- Tool registration and discovery
- Error handling and responses
- Authentication (if added)
- Streaming responses (if added)

### Research Data Pipeline Changes

#### Automod Evaluation Pipeline

**Components**: `[buttermilk flows, BigQuery, dbt models, Streamlit, analysis scripts]`

**Data Flow**:

```
Buttermilk Flows (JUDGE/SYNTH agents)
  ↓
BigQuery (AgentTrace records)
  ↓
dbt Models (aggregate/transform)
  ↓
Streamlit Dashboard
  ↓
Paper Analysis (papers/automod/)
```

**Change Protocol**:

1. Flow config changes: Add to `automod.cc/conf/`, results auto-logged
2. Data schema changes: Update dbt staging models first
3. Analysis changes: Use dbt models as source of truth
4. Dashboard changes: Document in project strategic doc

#### TJA Analysis Pipeline

**Components**: `[automod flows, BigQuery, dbt models, papers/automod/tja/]`

**Critical Dependencies**:

- Golden set: 28 hand-coded articles in BigQuery
- Evaluation criteria: TJA/GLAAD/HRC guidelines
- dbt models: `papers/automod/tja/dbt/models/`

**Change Protocol**:

1. Never modify golden set without documentation
2. New experiments: Add YAML configs, not code changes
3. Analysis updates: Use dbt for data transformation
4. Paper updates: Reference dbt models and dashboard

## Agent Halt Conditions

Agents MUST halt and request user approval when detecting:

### Automatic Halts

1. **Breaking changes to buttermilk** - see issue #64
2. **Schema changes to shared BigQuery tables**
3. **Changes to golden datasets** (TJA articles, evaluation criteria)
4. **Deployment to production** without test passing
5. **Deletion of data or models**

### Warning Conditions (proceed with caution)

1. **Compatible buttermilk changes** - test all dependents
2. **dbt model refactoring** - version and test
3. **Docker architecture divergence** - document reason
4. **New MCP tools** - ensure protocol compatibility

## Validation Checklist

Before committing changes, agents should verify:

- [ ] All tests pass in modified project
- [ ] Dependent projects tested if infrastructure changed
- [ ] Documentation updated (dbt schema.yml, project docs)
- [ ] Strategic doc updated if milestone reached
- [ ] GitHub issue created if coordination needed
- [ ] `project_sync.py` called to update context docs

## Update Protocol

After significant changes, agents MUST call:

```bash
bot/scripts/project_sync.py --project {project_name} --event {event_type}
```

**Event types**:

- `commit`: Update recent activity from git log
- `milestone`: Update strategic doc status
- `deployment`: Record deployment timestamp
- `test_status`: Update test results
- `breaking_change`: Flag for coordination

This updates:

- `docs/projects/{project}.md` (technical context)
- `data/projects/{project}.md` (strategic status)
- This file (dependency graph if needed)
