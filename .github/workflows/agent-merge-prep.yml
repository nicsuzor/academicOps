# Agent: Merge Prep
# Personality: Diligent and thorough. The janitor. Fixes what the reviewers found.
# Responsibilities:
#   - Read all review comments from pipeline agents and external bots
#   - Triage: fix genuine bugs, respond to false positives, defer scope creep
#   - Push fixes so the pipeline re-runs with clean code
#   - Post a triage summary comment
# Authority: Can EDIT code, push commits, post comments
# Prompt: .github/agents/merge-prep.md

name: "Agent: Merge Prep"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to prepare'
        type: string
        required: true
      ref:
        description: 'Git ref to checkout'
        type: string
        required: true
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number to prepare'
        type: string
        required: true
      ref:
        description: 'Git ref to checkout'
        type: string
        required: true

jobs:
  fix:
    name: Merge Prep
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Check if last push was from merge-prep
        id: loop-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prevent infinite loop: if the last commit was pushed by merge-prep,
          # skip this run. Uses a trailer in the commit message rather than
          # author name, since other bots (autofix lint, dependabot) also
          # commit as github-actions[bot].
          LAST_MSG=$(git log -1 --format='%B')
          if echo "$LAST_MSG" | grep -q 'Merge-Prep-By:'; then
            echo "Last commit was from merge-prep â€” skipping to avoid loop"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for outstanding review comments
        id: review-check
        if: steps.loop-check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ inputs.pr_number }}"

          # Check if any agent requested changes
          CHANGES_REQUESTED=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/reviews \
            --jq '[.[] | select(.state == "CHANGES_REQUESTED")] | length')

          # Check for unresolved review comments
          COMMENTS=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/comments \
            --jq 'length')

          echo "Changes requested: $CHANGES_REQUESTED"
          echo "Review comments: $COMMENTS"

          if [ "$CHANGES_REQUESTED" -gt 0 ] || [ "$COMMENTS" -gt 0 ]; then
            echo "has_feedback=true" >> $GITHUB_OUTPUT
          else
            echo "has_feedback=false" >> $GITHUB_OUTPUT
          fi

      - name: Read agent instructions
        if: steps.loop-check.outputs.skip != 'true' && steps.review-check.outputs.has_feedback == 'true'
        id: prompt
        run: |
          PROMPT=$(cat .github/agents/merge-prep.md)
          {
            echo "prompt<<AGENT_EOF"
            echo "$PROMPT"
            echo "AGENT_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Merge Prep
        if: steps.loop-check.outputs.skip != 'true' && steps.review-check.outputs.has_feedback == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude[bot]"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ${{ steps.prompt.outputs.prompt }}

            ---

            Prepare PR #${{ inputs.pr_number }} in repository ${{ github.repository }}.
            Use `gh pr view ${{ inputs.pr_number }}`, `gh pr diff ${{ inputs.pr_number }}`,
            and `gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }}/reviews`
            to gather all review feedback.

            Fix what you can, respond to false positives, and post your triage summary.

          claude_args: '--allowed-tools "Bash,Edit,Read,Write"'

      - name: Post loop-skip notice
        if: steps.loop-check.outputs.skip == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ inputs.pr_number }}"

          # Gather unresolved review state so the human knows what's outstanding
          CHANGES_REQUESTED=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/reviews \
            --jq '[.[] | select(.state == "CHANGES_REQUESTED")] | length')
          COMMENT_COUNT=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/comments \
            --jq 'length')

          BODY="## Merge Prep: Skipped (loop detection)"
          BODY="${BODY}\n\nThe last commit was already from merge-prep. Skipping to avoid infinite loop."

          if [ "$CHANGES_REQUESTED" -gt 0 ] || [ "$COMMENT_COUNT" -gt 0 ]; then
            BODY="${BODY}\n\n**Unresolved feedback remains:**"
            BODY="${BODY}\n- Reviews requesting changes: ${CHANGES_REQUESTED}"
            BODY="${BODY}\n- Inline review comments: ${COMMENT_COUNT}"
            BODY="${BODY}\n\nPlease review these manually before merging."
          else
            BODY="${BODY}\n\nNo outstanding review comments detected."
          fi

          echo -e "$BODY" | gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body-file -

      - name: Post no-action summary
        if: steps.loop-check.outputs.skip != 'true' && steps.review-check.outputs.has_feedback == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --body "$(cat <<'EOF'
          ## Merge Prep: No Review Comments

          All review agents approved. No comments to address.
          Ready for human review.
          EOF
          )"
