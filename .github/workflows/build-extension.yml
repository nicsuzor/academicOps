name: Build and Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen

      - name: Build distributions
        run: uv run python scripts/build.py
        env:
          ACA_DATA: ${{ github.workspace }}

      - name: Setup SSH for dist repo
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AOPS_DIST_DEPLOY_KEY }}

      - name: Push to dist repo
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone git@github.com:nicsuzor/aops-dist.git ../aops-dist

          # Clear old artifacts
          rm -rf ../aops-dist/aops-core-* ../aops-dist/antigravity ../aops-dist/*.tar.gz ../aops-dist/*.zip

          # Copy new build
          cp -r dist/* ../aops-dist/

          cd ../aops-dist
          git add -A
          git commit -m "Build from academicOps@${{ github.sha }}" || echo "No changes to commit"
          git push
