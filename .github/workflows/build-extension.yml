name: Build and Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating releases on dist repo
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen

      - name: Get project version
        id: version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Setup SSH for dist repo
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AOPS_DIST_DEPLOY_KEY }}

      - name: Check if version exists in dist repo
        id: check_version
        run: |
          git clone git@github.com:nicsuzor/aops-dist.git ../aops-dist

          # Check if version file exists and matches
          if [ -f "../aops-dist/VERSION" ]; then
            DIST_VERSION=$(cat ../aops-dist/VERSION)
            echo "Dist repo version: $DIST_VERSION"
            if [ "$DIST_VERSION" = "${{ steps.version.outputs.version }}" ]; then
              echo "version_changed=false" >> $GITHUB_OUTPUT
              echo "Version unchanged, skipping build"
            else
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "Version changed: $DIST_VERSION -> ${{ steps.version.outputs.version }}"
            fi
          else
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "No VERSION file found, will deploy"
          fi

      - name: Build distributions
        if: steps.check_version.outputs.version_changed == 'true'
        run: uv run python scripts/build.py
        env:
          ACA_DATA: ${{ github.workspace }}

      - name: Deploy to dist repo
        if: steps.check_version.outputs.version_changed == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GH_TOKEN: ${{ secrets.AOPS_DIST_DEPLOY_KEY }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          cd ../aops-dist

          # Clear old plugin directories (keep README, VERSION)
          rm -rf aops-core-claude aops-core-gemini antigravity .claude-plugin

          # Copy plugin directories (not archives)
          cp -r ${{ github.workspace }}/dist/aops-core-claude .
          cp -r ${{ github.workspace }}/dist/aops-core-gemini .
          cp -r ${{ github.workspace }}/dist/antigravity .

          # Copy gemini-extension.json to repo root (keeping it as a fallback)
          cp ${{ github.workspace }}/dist/aops-core-gemini/gemini-extension.json .
          python3 << EOF
          import json
          import os
          version = os.environ['VERSION']
          with open('gemini-extension.json', 'r') as f:
              data = json.load(f)
          # Update version
          data['version'] = version
          # DO NOT adjust paths to point to aops-core-gemini subdirectory
          # We want users to link/install aops-core-gemini directly
          with open('gemini-extension.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF

          # Copy marketplace definition
          mkdir -p .claude-plugin
          cp ${{ github.workspace }}/.claude-plugin/marketplace.json .claude-plugin/

          # Copy README from source repo
          cp ${{ github.workspace }}/README.md .

          # Update VERSION file
          echo "$VERSION" > VERSION

          # Update marketplace.json source paths and version for dist repo
          python3 << EOF
          import json
          import os
          version = os.environ['VERSION']
          with open('.claude-plugin/marketplace.json', 'r') as f:
              data = json.load(f)
          for plugin in data.get('plugins', []):
              if plugin.get('name') == 'aops-core':
                  plugin['source'] = './aops-core-claude'
                  plugin['version'] = version
          with open('.claude-plugin/marketplace.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF

          # Update aops-core-claude/plugin.json version
          python3 << EOF
          import json
          import os
          version = os.environ['VERSION']
          with open('aops-core-claude/plugin.json', 'r') as f:
              data = json.load(f)
          data['version'] = version
          with open('aops-core-claude/plugin.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF

          # Commit and push
          git add -A
          git commit -m "Release v$VERSION from academicOps@${{ github.sha }}" || echo "No changes to commit"
          git push

      - name: Create GitHub Release on dist repo
        if: steps.check_version.outputs.version_changed == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GH_TOKEN: ${{ secrets.AOPS_DIST_PAT }}
        run: |
          # Create release using GitHub CLI with PAT that has repo access
          gh release create "v$VERSION" \
            --repo nicsuzor/aops-dist \
            --title "v$VERSION" \
            --notes "Built from academicOps@${{ github.sha }}" \
            ${{ github.workspace }}/dist/*.tar.gz \
            ${{ github.workspace }}/dist/*.zip \
            || echo "Release v$VERSION may already exist"
