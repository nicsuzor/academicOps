name: PR Pipeline

on:
  pull_request:
    types: [opened, synchronize, assigned]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to run LGTM merge on'
        required: true
        type: number

jobs:
  claude-review:
    # Only run bot triage on new/updated PRs
    if: >-
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'synchronize')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Claude reviews bot comments
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude[bot],jules[bot]"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }}.

            ## Task

            1. Fetch all review comments on this PR using `gh pr view ${{ github.event.pull_request.number }} --comments` and `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews`.
            2. Identify comments from bot reviewers (Copilot, Gemini Code Assist).
            3. Triage each bot comment into one of:
               - **Genuine bug**: A real defect that would cause incorrect behavior. FIX IT.
               - **Valid improvement**: A meaningful code quality improvement. FIX IT.
               - **False positive**: The bot misunderstood the code. RESPOND with a brief explanation.
               - **Scope creep**: A valid suggestion but outside this PR's scope. ACKNOWLEDGE as future work.
            4. Make code fixes for genuine bugs and valid improvements. Commit and push changes.
            5. Reply to each bot comment thread with your assessment and action taken.
            6. Post a summary comment on the PR:
               ```
               ## Bot Review Triage

               | Reviewer | Comment | Category | Action |
               |----------|---------|----------|--------|
               | ... | ... | ... | ... |

               **Changes made**: [count] fixes committed
               **Deferred**: [count] items flagged as future work
               ```

            ## Rules
            - Do NOT address human reviewer comments — those are handled in the merge workflow.
            - Do NOT merge the PR. Your job is to address bot feedback only.
            - If no bot reviews exist, post a comment noting this and exit.
            - Run tests after making changes to verify nothing is broken.

          claude_args: '--allowed-tools "Bash(gh:*),Bash(git:*),Bash(npm:*),Bash(python:*),Bash(pytest:*),Bash(uv:*),Edit,Read,Write"'

  custodiet-and-qa:
    needs: claude-review
    # Only runs after claude-review, which already gates on pull_request opened/synchronize
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Read custodiet instructions
        id: custodiet-prompt
        run: |
          PROMPT=$(cat .github/agents/custodiet.md)
          {
            echo "prompt<<CUSTODIET_EOF"
            echo "$PROMPT"
            echo "CUSTODIET_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Read QA instructions
        id: qa-prompt
        run: |
          PROMPT=$(cat .github/agents/qa.md)
          {
            echo "prompt<<QA_EOF"
            echo "$PROMPT"
            echo "QA_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Custodiet Agent
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ${{ steps.custodiet-prompt.outputs.prompt }}

            ---

            Review PR #${{ github.event.pull_request.number }} in repository ${{ github.repository }}.
            Use `gh pr view ${{ github.event.pull_request.number }}` and `gh pr diff ${{ github.event.pull_request.number }}` to gather information.

          claude_args: '--allowed-tools "Bash(gh:*),Read"'

      - name: Run QA Agent
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ${{ steps.qa-prompt.outputs.prompt }}

            ---

            Review PR #${{ github.event.pull_request.number }} in repository ${{ github.repository }}.
            Use `gh pr view ${{ github.event.pull_request.number }}`, `gh pr diff ${{ github.event.pull_request.number }}`, and `gh pr checks ${{ github.event.pull_request.number }}` to gather information.

          claude_args: '--allowed-tools "Bash(gh:*),Read"'

  claude-lgtm-merge:
    # Run for: manual dispatch, PR assigned to claude, human-approved reviews, or LGTM comments from nicsuzor.
    # Bot approvals (from QA agent, custodiet, copilot, gemini, github-actions) must NOT trigger this —
    # only human reviewers or explicit workflow_dispatch should initiate the merge flow.
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' && github.event.action == 'assigned' && github.event.assignee.login == 'claude-for-github[bot]') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved' &&
        github.event.review.user.login != 'claude' &&
        github.event.review.user.login != 'github-actions[bot]' &&
        github.event.review.user.login != 'copilot-pull-request-reviewer' &&
        github.event.review.user.login != 'gemini-code-assist') ||
      (github.event_name == 'pull_request_review_comment' && github.event.comment.user.login == 'nicsuzor') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.comment.user.login == 'nicsuzor')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-merge-${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    steps:
      - name: Check LGTM pattern
        id: lgtm-check
        if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -iqE '^(lgtm|merge|rebase|ship it|@claude merge)'; then
            echo "Comment matches LGTM pattern"
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "Comment doesn't match merge pattern, skipping"
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine PR ref
        id: pr-ref
        if: >-
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'pull_request' ||
          github.event_name == 'pull_request_review' ||
          steps.lgtm-check.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}"
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

          # For pull_request events, the head ref is directly available
          if [ -n "${{ github.event.pull_request.head.ref }}" ]; then
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            # For comment/dispatch events, look up the head ref via gh CLI
            HEAD_REF=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json headRefName -q .headRefName)
            echo "ref=$HEAD_REF" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.pr-ref.outputs.ref != ''
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-ref.outputs.ref }}

      - name: Claude PR merge agent
        id: claude
        if: steps.pr-ref.outputs.ref != ''
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude[bot]"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            PR #${{ steps.pr-ref.outputs.pr_number }} has been approved.

            Please:
            1. Review the PR description and code changes to ensure they meet our standards.
            2. Respond to any outstanding review comments, either by making code changes or posting a comment explaining why no change is needed.
            3. Commit and push any changes to the PR branch.
            4. Verify CI checks are passing using `gh pr checks`.
            5. Post a final confirmation comment:
               - "LGTM: All review comments addressed and CI checks passed. Ready to merge."
               OR
               - "Request changes: Address the remaining issues before this PR can be merged."
               OR
               - "Close: PR does not meet standards or requires design discussion."

            ## Merging PRs with review comments

            ### Bot review comments
            The pr-review-pipeline workflow may have already triaged and addressed bot reviewer comments
            (Copilot, Gemini Code Assist). Check for a "Bot Review Triage" summary comment on the PR.
            - If bot comments were already addressed: verify the fixes are adequate and move on.
            - If no triage comment exists: triage bot comments yourself using these categories:
              - Genuine bugs (e.g., type mismatch that would crash at runtime) - fix these
              - Valid improvements (e.g., move import out of loop, add error types to except) - fix these
              - False positives (e.g., claiming a key was removed when it wasn't) - respond explaining why no change is needed
              - Scope creep (e.g., "add more tests") - acknowledge as follow-up feedback

            ### Custodiet and QA agent reviews
            The pr-review-pipeline may have also run custodiet (scope/compliance) and QA (acceptance criteria)
            agents. Check for reviews from these agents.
            - If custodiet flagged issues: address scope or compliance concerns before merging.
            - If QA flagged issues: verify acceptance criteria are met and fix any regressions.
            - If these agents haven't run: proceed normally — they are not a merge gate.

            ### Human review comments
            Address ALL comments by repository owners and managers thoroughly. Do NOT ignore or dismiss comments or defer implementation. Treat these comments as CRITICAL REQUIREMENTS that MUST be addressed before merging.

            3. Rebase if required to resolve merge conflicts. Do NOT merge main into the PR branch. Always rebase to maintain a clean history.

            4. Always run tests after modifying code. The PR will ONLY be merged if all tests pass. If tests fail, fix the issues and push a new commit.

          claude_args: '--allowed-tools "Bash(gh pr:*),Bash(git:*),Edit,Read,Write"'

      - name: Approve PR
        if: steps.pr-ref.outputs.ref != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"

          # Only approve if Claude's last comment signals LGTM
          LAST_COMMENT=$(gh pr view "$PR_NUM" --json comments --jq '.comments[-1].body')
          if echo "$LAST_COMMENT" | grep -q "LGTM:"; then
            echo "Claude confirmed LGTM - approving PR #$PR_NUM"
            gh pr review "$PR_NUM" --approve
          else
            echo "Claude did not confirm LGTM - skipping approval"
            echo "Last comment excerpt: $(echo "$LAST_COMMENT" | head -1)"
          fi
