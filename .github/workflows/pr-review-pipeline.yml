# PR review pipeline: sequential agent chain after Code Quality passes.
#
# Triggers via workflow_run — only runs when Code Quality (lint + gatekeeper + type-check)
# ALL pass. If gatekeeper rejects, this pipeline never starts.
#
# Sequence: custodiet → qa → merge-prep → notify-ready
# Each agent reviews in order so downstream agents see previous feedback.
# Merge-prep auto-fixes review comments before the human sees the PR.
#
# See specs/pr-process.md for the full process documentation.

name: PR Review

on:
  workflow_run:
    workflows: ["Code Quality"]
    types: [completed]

concurrency:
  group: pr-review-${{ github.event.workflow_run.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────
  # Setup: extract PR metadata from workflow_run
  # ──────────────────────────────────────────────
  setup:
    name: Setup
    if: >-
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr-info.outputs.pr_number }}
      head_ref: ${{ steps.pr-info.outputs.head_ref }}
    steps:
      - name: Extract PR info from workflow_run
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          HEAD_REF="${{ github.event.workflow_run.pull_requests[0].head.ref }}"

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "::error::Could not determine PR number from workflow_run event"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "PR #$PR_NUMBER on branch $HEAD_REF"

  # ──────────────────────────────────────────────
  # Stage 1: Custodiet (scope compliance)
  # ──────────────────────────────────────────────
  custodiet:
    name: Custodiet
    needs: [setup]
    uses: ./.github/workflows/agent-custodiet.yml
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    with:
      target_type: pr
      target_number: ${{ needs.setup.outputs.pr_number }}
      ref: ${{ needs.setup.outputs.head_ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Stage 2: QA (acceptance criteria)
  # ──────────────────────────────────────────────
  qa:
    name: QA
    needs: [setup, custodiet]
    uses: ./.github/workflows/agent-qa.yml
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    with:
      pr_number: ${{ needs.setup.outputs.pr_number }}
      ref: ${{ needs.setup.outputs.head_ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Stage 3: Merge Prep (auto-fix review comments)
  # ──────────────────────────────────────────────
  merge-prep:
    name: Merge Prep
    needs: [setup, qa]
    uses: ./.github/workflows/agent-merge-prep.yml
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    with:
      pr_number: ${{ needs.setup.outputs.pr_number }}
      ref: ${{ needs.setup.outputs.head_ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Stage 4: Ready for Review notification
  # ──────────────────────────────────────────────
  notify-ready:
    name: Ready for Review
    needs: [setup, merge-prep]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check outstanding review state
        id: review-state
        run: |
          PR_NUM="${{ needs.setup.outputs.pr_number }}"

          CHANGES_REQUESTED=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/reviews \
            --jq '[.[] | select(.state == "CHANGES_REQUESTED")] | length')
          COMMENT_COUNT=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/comments \
            --jq 'length')

          echo "changes_requested=$CHANGES_REQUESTED" >> "$GITHUB_OUTPUT"
          echo "comment_count=$COMMENT_COUNT" >> "$GITHUB_OUTPUT"

          if [ "$CHANGES_REQUESTED" -gt 0 ] || [ "$COMMENT_COUNT" -gt 0 ]; then
            echo "has_unresolved=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_unresolved=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post pipeline summary (clean)
        if: steps.review-state.outputs.has_unresolved == 'false'
        run: |
          PR_NUM="${{ needs.setup.outputs.pr_number }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<'SUMMARY'
          ## Pipeline Complete — Ready for Human Review

          All automated stages have finished:

          | Stage | Agent | Role |
          |-------|-------|------|
          | 1. Code Quality | Lint + Gatekeeper + Type Check | Syntax, alignment, types |
          | 2. Custodiet | Scope compliance | Principle violations, unauthorized changes |
          | 3. QA | Acceptance criteria | Tests, regressions, correctness |
          | 4. Merge Prep | Auto-fix | Review comments triaged and addressed |

          **Your approval is the last step needed to merge.**
          SUMMARY
          )"

      - name: Post pipeline summary (with unresolved feedback)
        if: steps.review-state.outputs.has_unresolved == 'true'
        run: |
          PR_NUM="${{ needs.setup.outputs.pr_number }}"
          CHANGES="${{ steps.review-state.outputs.changes_requested }}"
          COMMENTS="${{ steps.review-state.outputs.comment_count }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<SUMMARY
          ## Pipeline Complete — Unresolved Feedback Remains

          All automated stages have finished:

          | Stage | Agent | Role |
          |-------|-------|------|
          | 1. Code Quality | Lint + Gatekeeper + Type Check | Syntax, alignment, types |
          | 2. Custodiet | Scope compliance | Principle violations, unauthorized changes |
          | 3. QA | Acceptance criteria | Tests, regressions, correctness |
          | 4. Merge Prep | Auto-fix | Review comments triaged and addressed |

          **Unresolved feedback:**
          - Reviews requesting changes: ${CHANGES}
          - Inline review comments: ${COMMENTS}

          **Please review the outstanding comments before approving.**
          SUMMARY
          )"
