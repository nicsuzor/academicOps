# PR review pipeline: strategic-review, custodiet, and QA run in PARALLEL.
# All three are independent reviewers that post comments/reviews — no serial dependency.
#
# Triggers directly on pull_request events. Reviews are advisory and do not
# block merge (the ruleset only requires Lint + approvals).
#
# Merge agent lives in pr-lgtm-merge.yml (separate triggers).
# Issue reviews live in issue-review.yml (separate triggers).
#
# See specs/pr-process.md for the full process documentation.

name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ──────────────────────────────────────────────
  # Three review agents run in parallel — no serial chaining.
  # Each is a reusable agent workflow with its own personality and authority.
  # ──────────────────────────────────────────────

  strategic-review:
    name: Strategic Review
    uses: ./.github/workflows/agent-strategic-review.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      ref: ${{ github.event.pull_request.head.ref }}
    secrets: inherit

  custodiet:
    name: Custodiet
    uses: ./.github/workflows/agent-custodiet.yml
    with:
      target_type: pr
      target_number: ${{ github.event.pull_request.number }}
      ref: ${{ github.event.pull_request.head.ref }}
    secrets: inherit

  qa:
    name: QA
    uses: ./.github/workflows/agent-qa.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      ref: ${{ github.event.pull_request.head.ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Ready for Review notification (after all agents complete)
  # ──────────────────────────────────────────────
  notify-ready:
    name: Ready for Review
    needs: [strategic-review, custodiet, qa]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Post pipeline summary
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<'SUMMARY'
          ## Review Pipeline Complete

          All automated review agents have finished:

          | Agent | Role |
          |-------|------|
          | Strategic Review | Design coherence, framework alignment |
          | Custodiet | Scope compliance, principle violations |
          | QA | Acceptance criteria, test coverage, regressions |

          **Ready for human review.** Check individual agent comments above for details.
          SUMMARY
          )"
