# PR review pipeline: sequential agent chain after Code Quality passes.
#
# Triggers via workflow_run — only runs when Code Quality (lint + gatekeeper + type-check)
# ALL pass. If gatekeeper rejects, this pipeline never starts.
#
# Sequence: custodiet → qa → merge-prep → notify-ready
# Each agent reviews in order so downstream agents see previous feedback.
# Merge-prep auto-fixes review comments before the human sees the PR.
#
# See specs/pr-process.md for the full process documentation.

name: PR Review

on:
  workflow_run:
    workflows: ["Code Quality"]
    types: [completed]

jobs:
  # ──────────────────────────────────────────────
  # Setup: extract PR metadata from workflow_run
  # ──────────────────────────────────────────────
  setup:
    name: Setup
    if: >-
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr-info.outputs.pr_number }}
      head_ref: ${{ steps.pr-info.outputs.head_ref }}
    steps:
      - name: Extract PR info from workflow_run
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          HEAD_REF="${{ github.event.workflow_run.pull_requests[0].head.ref }}"

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "::error::Could not determine PR number from workflow_run event"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "PR #$PR_NUMBER on branch $HEAD_REF"

  # ──────────────────────────────────────────────
  # Stage 1: Custodiet (scope compliance)
  # ──────────────────────────────────────────────
  custodiet:
    name: Custodiet
    needs: [setup]
    uses: ./.github/workflows/agent-custodiet.yml
    with:
      target_type: pr
      target_number: ${{ needs.setup.outputs.pr_number }}
      ref: ${{ needs.setup.outputs.head_ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Stage 2: QA (acceptance criteria)
  # ──────────────────────────────────────────────
  qa:
    name: QA
    needs: [setup, custodiet]
    uses: ./.github/workflows/agent-qa.yml
    with:
      pr_number: ${{ needs.setup.outputs.pr_number }}
      ref: ${{ needs.setup.outputs.head_ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Stage 3: Merge Prep (auto-fix review comments)
  # ──────────────────────────────────────────────
  merge-prep:
    name: Merge Prep
    needs: [setup, qa]
    uses: ./.github/workflows/agent-merge-prep.yml
    with:
      pr_number: ${{ needs.setup.outputs.pr_number }}
      ref: ${{ needs.setup.outputs.head_ref }}
    secrets: inherit

  # ──────────────────────────────────────────────
  # Stage 4: Ready for Review notification
  # ──────────────────────────────────────────────
  notify-ready:
    name: Ready for Review
    needs: [setup, merge-prep]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Post pipeline summary
        run: |
          PR_NUM="${{ needs.setup.outputs.pr_number }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<'SUMMARY'
          ## Pipeline Complete — Ready for Human Review

          All automated stages have finished:

          | Stage | Agent | Role |
          |-------|-------|------|
          | 1. Code Quality | Lint + Gatekeeper + Type Check | Syntax, alignment, types |
          | 2. Custodiet | Scope compliance | Principle violations, unauthorized changes |
          | 3. QA | Acceptance criteria | Tests, regressions, correctness |
          | 4. Merge Prep | Auto-fix | Review comments triaged and addressed |

          **Your approval is the last step needed to merge.**
          SUMMARY
          )"
