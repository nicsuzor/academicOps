# Sets the "Merge Prep" commit status to "pending" on every PR push.
# This blocks GitHub auto-merge until the merge-prep agent explicitly
# sets the status to "success" after its review + cleanup pass.
#
# See specs/pr-process-v2-draft.md for the full process documentation.

name: Merge Prep Gate

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  gate:
    name: Set Merge Prep Pending
    runs-on: ubuntu-latest
    permissions:
      statuses: write
    steps:
      - name: Set Merge Prep status to pending
        env:
          GH_TOKEN: ${{ secrets.AOPS_BOT_GH_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f state=pending \
            -f context="Merge Prep" \
            -f description="Awaiting LGTM + merge-prep review" \
            -f target_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
