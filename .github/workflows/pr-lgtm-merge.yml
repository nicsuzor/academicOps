# LGTM workflow: records human approval and enables auto-merge.
#
# When the human says "lgtm" (or approves via GitHub review), this workflow:
#   1. Adds the 'lgtm' label (for the cron dispatcher to pick up)
#   2. Checks whether required status checks are passing
#   3. If checks haven't run and PR is not conflicting, re-triggers code-quality
#   4. Enables GitHub auto-merge (rebase mode)
#   5. Posts acknowledgment
#
# This workflow is intentionally lightweight (< 30s). Heavy work like
# conflict resolution and review triage is handled by merge-prep (cron).
#
# See specs/pr-process.md for full process documentation.

name: LGTM

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: true
        type: number

jobs:
  lgtm:
    name: Record LGTM
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        github.event.comment.user.login == 'nicsuzor')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-lgtm-${{ inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check LGTM pattern (comment trigger)
        id: lgtm-check
        if: github.event_name == 'issue_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -iqE '^(lgtm|merge|ship it)'; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
          else
            echo "proceed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine PR number
        id: pr-ref
        if: >-
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'pull_request_review' ||
          steps.lgtm-check.outputs.proceed == 'true'
        run: |
          PR_NUM="${{ inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}"
          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"

      # ── Gather PR state ──

      - name: Get PR details
        id: pr-details
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          REPO="${{ github.repository }}"

          # GitHub computes mergeable state lazily — poll until resolved
          for i in 1 2 3 4 5; do
            PR_DATA=$(gh pr view "$PR_NUM" --repo "$REPO" \
              --json headRefName,headRefOid,mergeable,mergeStateStatus)
            MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
            if [ "$MERGEABLE" != "UNKNOWN" ]; then
              break
            fi
            echo "Mergeable state is UNKNOWN (attempt $i/5), waiting 5s..."
            sleep 5
          done

          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.headRefOid')
          MERGE_STATE=$(echo "$PR_DATA" | jq -r '.mergeStateStatus')

          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "mergeable=$MERGEABLE" >> "$GITHUB_OUTPUT"
          echo "merge_state=$MERGE_STATE" >> "$GITHUB_OUTPUT"
          echo "Mergeable: $MERGEABLE, Merge state: $MERGE_STATE"

      # ── Re-trigger checks if needed (non-conflicting PRs only) ──
      # For conflicting PRs, merge-prep will resolve conflicts first,
      # then checks re-run on the clean branch.

      - name: Re-trigger code-quality if checks haven't run
        if: >-
          steps.pr-ref.outputs.pr_number != '' &&
          steps.pr-details.outputs.mergeable != 'CONFLICTING'
        run: |
          HEAD_SHA="${{ steps.pr-details.outputs.head_sha }}"
          HEAD_REF="${{ steps.pr-details.outputs.head_ref }}"
          REPO="${{ github.repository }}"

          # Check if Lint has run on this HEAD
          LINT_STATE=$(gh api "repos/$REPO/commits/$HEAD_SHA/check-runs" \
            --jq '.check_runs[] | select(.name == "Lint") | .conclusion' 2>/dev/null | head -1)

          if [ -z "$LINT_STATE" ]; then
            echo "Lint has not run on HEAD — re-triggering code-quality"
            gh workflow run code-quality.yml --repo "$REPO" --ref "$HEAD_REF" \
              || echo "Warning: could not trigger code-quality"
          else
            echo "Lint status: $LINT_STATE"
          fi

      # ── Record LGTM ──

      - name: Add lgtm label
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          gh pr edit "${{ steps.pr-ref.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "lgtm"

      - name: Enable auto-merge
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          gh pr merge "${{ steps.pr-ref.outputs.pr_number }}" \
            --auto --rebase \
            --repo "${{ github.repository }}"

      # ── React + acknowledge ──

      - name: React to comment
        if: github.event_name == 'issue_comment' && steps.lgtm-check.outputs.proceed == 'true'
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=rocket

      - name: Post acknowledgment
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          MERGEABLE="${{ steps.pr-details.outputs.mergeable }}"

          BODY="LGTM recorded. Auto-merge enabled."

          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            BODY="$BODY"$'\n\n'"**Merge conflicts detected.** Merge-prep will resolve them on the next cron cycle (~15 min)."
          else
            BODY="$BODY Will merge once all checks pass."
          fi

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$BODY"
