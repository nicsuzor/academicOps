# Merge Agent: triggered by human approval signals only.
# Handles review comment triage, final fixes, and adds PR to merge queue.
#
# Tight triggers — only fires on:
#   1. Human PR review approval (not bot reviews)
#   2. LGTM-pattern comment from nicsuzor
#   3. Manual workflow dispatch
#
# Separated from pr-review-pipeline.yml so review and merge triggers
# don't cross-contaminate each other's check lists with SKIPPED entries.
#
# See specs/pr-process.md for full process documentation.

name: Merge Agent

on:
  # Human approval via formal review
  pull_request_review:
    types: [submitted]
  # LGTM comment from owner
  issue_comment:
    types: [created]
  # Manual trigger for specific PRs
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to run LGTM merge on'
        required: true
        type: number

jobs:
  claude-lgtm-merge:
    # Tight filters:
    #   - workflow_dispatch: always run
    #   - pull_request_review: only human approvals (not bot reviews from agents)
    #   - issue_comment: only LGTM-pattern from nicsuzor on PRs
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        github.event.comment.user.login == 'nicsuzor')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-merge-${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: write
      actions: read
    steps:
      - name: Check LGTM pattern
        id: lgtm-check
        if: github.event_name == 'issue_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -iqE '^(lgtm|merge|rebase|ship it|@claude merge)'; then
            echo "Comment matches LGTM pattern"
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "Comment doesn't match merge pattern, skipping"
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge comment
        if: >-
          github.event_name == 'issue_comment' &&
          steps.lgtm-check.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=eyes

      - name: Determine PR ref
        id: pr-ref
        if: >-
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'pull_request_review' ||
          steps.lgtm-check.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}"
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

          # For pull_request_review events, the head ref is directly available
          if [ -n "${{ github.event.pull_request.head.ref }}" ]; then
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            # For comment/dispatch events, look up the head ref via gh CLI
            HEAD_REF=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json headRefName -q .headRefName)
            echo "ref=$HEAD_REF" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.pr-ref.outputs.ref != ''
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-ref.outputs.ref }}

      - name: Claude PR merge agent
        id: claude
        if: steps.pr-ref.outputs.ref != ''
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude[bot]"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            PR #${{ steps.pr-ref.outputs.pr_number }} has been approved.

            Please prepare this PR for merge:

            1. **Aggregate all review comments** from bot reviewers (Copilot, Gemini Code Assist),
               custodiet, QA, and human reviewers using `gh pr view` and `gh api`.
            2. **Triage bot comments** into categories:
               - Genuine bugs (e.g., type mismatch that would crash at runtime) -> FIX
               - Valid improvements (e.g., move import out of loop, add error types to except) -> FIX
               - False positives (e.g., claiming a key was removed when it wasn't) -> RESPOND explaining why
               - Scope creep (e.g., "add more tests") -> ACKNOWLEDGE as follow-up
            3. **Address human reviewer comments** — these are critical requirements. Do NOT ignore
               or dismiss human comments or defer implementation.
            4. Commit and push any changes to the PR branch.
            5. Rebase on main if required to resolve merge conflicts. Do NOT merge main into the
               PR branch. Always rebase to maintain a clean history.
            6. Fix any lint or CI errors introduced by your changes.
            7. Run tests after modifying code. The PR will ONLY be merged if all tests pass.
            8. Post a final confirmation comment:
               - "LGTM: All review comments addressed and CI checks passed. Ready to merge."
               OR
               - "Request changes: Address the remaining issues before this PR can be merged."
               OR
               - "Close: PR does not meet standards or requires design discussion."

            Post a summary table of triaged comments:
            ```
            ## Review Comment Triage

            | Reviewer | Comment | Category | Action |
            |----------|---------|----------|--------|
            | ... | ... | ... | ... |

            **Changes made**: [count] fixes committed
            **Deferred**: [count] items flagged as future work
            ```

          claude_args: '--allowed-tools "Bash,Edit,Read,Write"'

      - name: Check LGTM status
        id: lgtm-status
        if: steps.pr-ref.outputs.ref != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"

          # Only proceed if Claude's last comment signals LGTM
          LAST_COMMENT=$(gh pr view "$PR_NUM" --json comments --jq '.comments[-1].body')
          if echo "$LAST_COMMENT" | grep -q "LGTM:"; then
            echo "Claude confirmed LGTM"
            echo "lgtm=true" >> $GITHUB_OUTPUT
          else
            echo "Claude did not confirm LGTM - skipping approval"
            echo "Last comment excerpt: $(echo "$LAST_COMMENT" | head -1)"
            echo "lgtm=false" >> $GITHUB_OUTPUT
          fi

      - name: Dismiss claude[bot] change requests
        if: steps.pr-ref.outputs.ref != '' && steps.lgtm-status.outputs.lgtm == 'true'
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"

          # Find and dismiss any CHANGES_REQUESTED reviews from claude[bot]
          # This unblocks GitHub auto-merge which may be waiting on unresolved reviews
          REVIEW_IDS=$(gh api repos/${{ github.repository }}/pulls/${PR_NUM}/reviews \
            --jq '[.[] | select(.user.login == "claude[bot]" and .state == "CHANGES_REQUESTED")] | .[].id')

          if [ -n "$REVIEW_IDS" ]; then
            for REVIEW_ID in $REVIEW_IDS; do
              echo "Dismissing review $REVIEW_ID from claude[bot]"
              gh api repos/${{ github.repository }}/pulls/${PR_NUM}/reviews/${REVIEW_ID}/dismissals \
                -X PUT -f message="Superseded: All review comments addressed and LGTM confirmed."
            done
          else
            echo "No CHANGES_REQUESTED reviews from claude[bot] to dismiss"
          fi

      - name: Approve PR
        if: steps.pr-ref.outputs.ref != '' && steps.lgtm-status.outputs.lgtm == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          echo "Approving PR #$PR_NUM"
          gh pr review "$PR_NUM" --approve

      - name: Add to merge queue
        if: steps.pr-ref.outputs.ref != '' && steps.lgtm-status.outputs.lgtm == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"

          # Add to merge queue (preferred path when merge queue is enabled).
          if gh pr merge "$PR_NUM" --merge-queue --repo "${{ github.repository }}" 2>/dev/null; then
            echo "PR #$PR_NUM added to merge queue"
          else
            echo "Merge queue not available - falling back to auto-merge (direct rebase on check pass)"
            gh pr merge "$PR_NUM" --auto --rebase --repo "${{ github.repository }}" || {
              echo "Direct merge also failed - PR may require additional approvals or checks"
              exit 1
            }
          fi
