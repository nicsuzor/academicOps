# LGTM workflow: records human approval and drives the PR toward merge.
#
# When the human says "lgtm" (or approves via GitHub review), this workflow:
#   1. Detects LGTM pattern / approval
#   2. If merge conflicts, invokes Claude Code to intelligently rebase + resolve
#   3. Checks whether required status checks are passing
#   4. If checks haven't run or are failing, re-triggers code-quality via workflow_dispatch
#   5. Lodges Approval #2 (bot review — satisfies the 1-review ruleset requirement)
#   6. Adds the 'lgtm' label (for the cron dispatcher to pick up)
#   7. Enables GitHub auto-merge (rebase mode)
#   8. Posts acknowledgment summarizing what happened
#
# The human's LGTM comment may include instructions for merge-prep
# (e.g., "lgtm, but fix the docstring on line 42"). Merge-prep reads
# the comment when it runs.
#
# Tight triggers — only fires on:
#   1. Human PR review approval (not bot reviews)
#   2. LGTM-pattern comment from nicsuzor
#   3. Manual workflow dispatch
#
# See specs/pr-process.md for full process documentation.

name: LGTM

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: true
        type: number

jobs:
  lgtm:
    name: Record LGTM
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        github.event.comment.user.login == 'nicsuzor')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-lgtm-${{ inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      statuses: read
      actions: write
      checks: read
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check LGTM pattern (comment trigger)
        id: lgtm-check
        if: github.event_name == 'issue_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -iqE '^(lgtm|merge|ship it)'; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
          else
            echo "proceed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine PR number
        id: pr-ref
        if: >-
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'pull_request_review' ||
          steps.lgtm-check.outputs.proceed == 'true'
        run: |
          PR_NUM="${{ inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}"
          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"

      # ── Gather PR state ──

      - name: Get PR details
        id: pr-details
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          REPO="${{ github.repository }}"

          PR_DATA=$(gh pr view "$PR_NUM" --repo "$REPO" \
            --json headRefName,headRefOid,mergeable,mergeStateStatus)

          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.headRefOid')
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_DATA" | jq -r '.mergeStateStatus')

          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "mergeable=$MERGEABLE" >> "$GITHUB_OUTPUT"
          echo "merge_state=$MERGE_STATE" >> "$GITHUB_OUTPUT"

      # ── Resolve conflicts via Claude Code ──
      # Uses claude-code-action to intelligently rebase on main and resolve
      # any merge conflicts. This is the same pattern as our other agent
      # workflows (merge-prep, gatekeeper, etc.).

      - name: Checkout for conflict resolution
        if: steps.pr-details.outputs.mergeable == 'CONFLICTING' && steps.pr-ref.outputs.pr_number != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-details.outputs.head_ref }}
          fetch-depth: 0

      - name: Resolve merge conflicts via Claude
        id: resolve-conflicts
        if: steps.pr-details.outputs.mergeable == 'CONFLICTING' && steps.pr-ref.outputs.pr_number != ''
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            This PR branch has merge conflicts with main. Rebase it on main and resolve all conflicts intelligently.

            1. Run `git fetch origin main`
            2. Run `git rebase origin/main`
            3. When you encounter conflicts, resolve them by reading both sides and understanding the intent:
               - For additive changes (new imports, new list items, new functions), keep both sides
               - For logic conflicts, prefer the feature branch's intent unless it clearly contradicts main's changes
               - For config files (pyproject.toml, uv.lock), take main's version and re-add any feature branch additions
            4. After resolving each conflict: `git add <file>` then `git rebase --continue`
            5. When rebase is complete: `git push --force-with-lease`
            6. If truly unresolvable, `git rebase --abort` and explain why
          claude_args: '--allowed-tools "Bash,Read,Edit,Write" --max-turns 30'

      - name: Check conflict resolution result
        id: conflict-result
        if: steps.pr-details.outputs.mergeable == 'CONFLICTING' && steps.pr-ref.outputs.pr_number != ''
        run: |
          if [ "${{ steps.resolve-conflicts.outcome }}" = "success" ]; then
            echo "resolved=true" >> "$GITHUB_OUTPUT"
          else
            echo "resolved=false" >> "$GITHUB_OUTPUT"
          fi

      # ── Check required status checks ──
      # Skipped if conflicts could not be resolved (PR is not mergeable).

      - name: Get fresh HEAD SHA
        id: fresh-sha
        if: steps.pr-ref.outputs.pr_number != '' && steps.conflict-result.outputs.resolved != 'false'
        run: |
          # After a force-push the SHA changes — always get the current one
          SHA=$(gh pr view "${{ steps.pr-ref.outputs.pr_number }}" \
            --repo "${{ github.repository }}" --json headRefOid --jq '.headRefOid')
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Check status of required checks
        id: check-status
        if: steps.pr-ref.outputs.pr_number != '' && steps.conflict-result.outputs.resolved != 'false'
        run: |
          HEAD_SHA="${{ steps.fresh-sha.outputs.sha }}"
          REPO="${{ github.repository }}"
          BLOCKERS=""

          for CTX in "Lint" "Type Check" "Pytest"; do
            # Check commit statuses first
            STATE=$(gh api "repos/$REPO/commits/$HEAD_SHA/status" \
              --jq ".statuses[] | select(.context == \"$CTX\") | .state" 2>/dev/null | head -1)

            # Fall back to check-runs (GitHub Actions reports as check runs)
            if [ -z "$STATE" ]; then
              STATE=$(gh api "repos/$REPO/commits/$HEAD_SHA/check-runs" \
                --jq ".check_runs[] | select(.name == \"$CTX\") | .conclusion" 2>/dev/null | head -1)
            fi

            if [ -z "$STATE" ]; then
              echo "$CTX: NOT RUN"
              BLOCKERS="${BLOCKERS}${CTX} (not run), "
            elif [ "$STATE" != "success" ]; then
              echo "$CTX: $STATE"
              BLOCKERS="${BLOCKERS}${CTX} ($STATE), "
            else
              echo "$CTX: success"
            fi
          done

          # Check Gatekeeper (commit status)
          GK_STATE=$(gh api "repos/$REPO/commits/$HEAD_SHA/status" \
            --jq '.statuses[] | select(.context == "Gatekeeper") | .state' 2>/dev/null | head -1)
          if [ -z "$GK_STATE" ]; then
            echo "Gatekeeper: NOT RUN"
            BLOCKERS="${BLOCKERS}Gatekeeper (not run), "
          elif [ "$GK_STATE" != "success" ]; then
            echo "Gatekeeper: $GK_STATE"
            BLOCKERS="${BLOCKERS}Gatekeeper ($GK_STATE), "
          else
            echo "Gatekeeper: success"
          fi

          if [ -n "$BLOCKERS" ]; then
            # Trim trailing comma+space
            BLOCKERS="${BLOCKERS%, }"
            echo "all_passing=false" >> "$GITHUB_OUTPUT"
            echo "blockers=$BLOCKERS" >> "$GITHUB_OUTPUT"
          else
            echo "all_passing=true" >> "$GITHUB_OUTPUT"
            echo "blockers=" >> "$GITHUB_OUTPUT"
          fi

      # ── Re-trigger checks if they haven't run ──

      - name: Re-trigger code-quality if checks are missing
        if: >-
          steps.pr-ref.outputs.pr_number != '' &&
          steps.conflict-result.outputs.resolved != 'false' &&
          steps.check-status.outputs.all_passing == 'false'
        run: |
          HEAD_REF="${{ steps.pr-details.outputs.head_ref }}"
          REPO="${{ github.repository }}"

          echo "Checks not passing: ${{ steps.check-status.outputs.blockers }}"
          echo "Re-triggering code-quality on branch $HEAD_REF"

          gh workflow run code-quality.yml \
            --repo "$REPO" \
            --ref "$HEAD_REF" || echo "Warning: could not trigger code-quality (may need manual intervention)"

      # ── Record LGTM ──
      # Always add label (records intent even if conflicts can't be resolved).
      # Only approve + auto-merge if the PR is in a mergeable state.

      - name: Add lgtm label
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          gh pr edit "${{ steps.pr-ref.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "lgtm"

      - name: Lodge Approval (satisfies 1-review requirement)
        if: steps.pr-ref.outputs.pr_number != '' && steps.conflict-result.outputs.resolved != 'false'
        run: |
          gh pr review "${{ steps.pr-ref.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --approve \
            --body "LGTM recorded by automation. Human approval detected — lodging formal review to satisfy merge requirements."

      - name: Enable auto-merge
        if: steps.pr-ref.outputs.pr_number != '' && steps.conflict-result.outputs.resolved != 'false'
        run: |
          gh pr merge "${{ steps.pr-ref.outputs.pr_number }}" \
            --auto --rebase \
            --repo "${{ github.repository }}"

      # ── React + acknowledge ──

      - name: React to comment
        if: github.event_name == 'issue_comment' && steps.lgtm-check.outputs.proceed == 'true'
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=rocket

      - name: Post acknowledgment
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          BLOCKERS="${{ steps.check-status.outputs.blockers }}"
          RESOLVED="${{ steps.conflict-result.outputs.resolved }}"

          if [ "$RESOLVED" = "false" ]; then
            BODY="LGTM recorded, but **merge conflicts could not be auto-resolved** by Claude."
            BODY="$BODY"$'\n\n'"The \`lgtm\` label has been added. Please resolve conflicts manually, then comment \`lgtm\` again to re-trigger."
          elif [ "$RESOLVED" = "true" ]; then
            BODY="LGTM recorded. **Resolved merge conflicts** via Claude Code (rebase on main)."
            BODY="$BODY Auto-merge is enabled."
            if [ -n "$BLOCKERS" ]; then
              BODY="$BODY"$'\n\n'"**Checks not yet passing:** $BLOCKERS"$'\n'"Re-triggered code-quality workflow. Will merge automatically once checks pass."
            else
              BODY="$BODY Will merge once checks pass."
            fi
          else
            BODY="LGTM recorded. Auto-merge is enabled."
            if [ -n "$BLOCKERS" ]; then
              BODY="$BODY"$'\n\n'"**Checks not yet passing:** $BLOCKERS"$'\n'"Re-triggered code-quality workflow. Will merge automatically once checks pass."
            else
              BODY="$BODY Will merge shortly."
            fi
          fi

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$BODY"
