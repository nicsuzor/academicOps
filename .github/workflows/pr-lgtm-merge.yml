# LGTM workflow: records human approval and enables auto-merge.
#
# When the human says "lgtm" (or approves via GitHub review), this workflow:
#   1. Adds the 'lgtm' label (for the cron dispatcher to pick up)
#   2. Enables GitHub auto-merge (rebase mode)
#   3. Posts acknowledgment
#
# The human's LGTM comment may include instructions for merge-prep
# (e.g., "lgtm, but fix the docstring on line 42"). Merge-prep reads
# the comment when it runs.
#
# Tight triggers — only fires on:
#   1. Human PR review approval (not bot reviews)
#   2. LGTM-pattern comment from nicsuzor
#   3. Manual workflow dispatch
#
# See specs/pr-process-v2-draft.md for full process documentation.

name: LGTM

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: true
        type: number

jobs:
  lgtm:
    name: Record LGTM
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        github.event.comment.user.login == 'nicsuzor')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-lgtm-${{ inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check LGTM pattern (comment trigger)
        id: lgtm-check
        if: github.event_name == 'issue_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -iqE '^(lgtm|merge|ship it)'; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
          else
            echo "proceed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine PR number
        id: pr-ref
        if: >-
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'pull_request_review' ||
          steps.lgtm-check.outputs.proceed == 'true'
        run: |
          PR_NUM="${{ inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}"
          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"

      # ── Record LGTM ──

      - name: Add lgtm label
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          gh pr edit "${{ steps.pr-ref.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "lgtm"

      - name: Enable auto-merge
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          gh pr merge "${{ steps.pr-ref.outputs.pr_number }}" \
            --auto --rebase \
            --repo "${{ github.repository }}"

      - name: React to comment
        if: github.event_name == 'issue_comment' && steps.lgtm-check.outputs.proceed == 'true'
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=rocket

      - name: Post acknowledgment
        if: steps.pr-ref.outputs.pr_number != ''
        run: |
          gh pr comment "${{ steps.pr-ref.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --body "LGTM recorded. Merge Prep will process this PR on the next cycle (~15 min). Auto-merge is enabled and will fire once all checks pass."
