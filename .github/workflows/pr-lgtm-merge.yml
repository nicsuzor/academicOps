# Merge on human approval.
#
# By the time the human approves, all agents have reviewed and merge-prep has
# fixed their comments. This workflow just lodges Approval #2 and merges.
#
# Tight triggers — only fires on:
#   1. Human PR review approval (not bot reviews)
#   2. LGTM-pattern comment from nicsuzor
#   3. Manual workflow dispatch
#
# See specs/pr-process.md for full process documentation.

name: Merge

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to merge'
        required: true
        type: number

jobs:
  merge:
    name: Merge
    # Tight filters: human approval only
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        github.event.comment.user.login == 'nicsuzor')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-merge-${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    steps:
      - name: Check LGTM pattern
        id: lgtm-check
        if: github.event_name == 'issue_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -iqE '^(lgtm|merge|rebase|ship it|@claude merge)'; then
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine PR number
        id: pr-ref
        if: >-
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'pull_request_review' ||
          steps.lgtm-check.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}"
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

      - name: Acknowledge
        if: github.event_name == 'issue_comment' && steps.lgtm-check.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=rocket

      - name: Approve PR (Approval #2)
        if: steps.pr-ref.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          echo "Approving PR #$PR_NUM (Approval #2 — human-triggered)"
          gh pr review "$PR_NUM" --approve --body "Human approved. Merge-prep has addressed all review comments."

      - name: Merge PR
        if: steps.pr-ref.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-ref.outputs.pr_number }}"
          echo "Merging PR #$PR_NUM via rebase"
          gh pr merge "$PR_NUM" --rebase --repo "${{ github.repository }}"
