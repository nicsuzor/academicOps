name: PR Pipeline

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number for re-review'
        required: true
        type: number

concurrency:
  group: pr-pipeline-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: false

env:
  PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}

jobs:
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI checks
        run: |
          for i in {1..20}; do
            status=$(gh pr checks $PR_NUMBER --json state -q '.[] | select(.name != "PR Pipeline") | .state' | sort -u)
            if [[ "$status" == "SUCCESS" ]]; then exit 0; fi
            if [[ "$status" == *"FAILURE"* ]]; then exit 1; fi
            sleep 30
          done
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  review:
    needs: wait-for-ci
    runs-on: ubuntu-latest
    outputs:
      review_state: ${{ steps.check-state.outputs.state }}
      iteration_count: ${{ steps.get-iteration.outputs.count }}
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get iteration count
        id: get-iteration
        run: |
          body=$(gh pr view $PR_NUMBER --json body -q '.body')
          count=$(echo "$body" | grep -oP '(?<=<!-- iteration-count: )\d+(?= -->)' || echo "0")
          echo "count=$count" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Code Review
        if: fromJSON(steps.get-iteration.outputs.count) < 3
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review PR #${{ env.PR_NUMBER }}. Focus on:
            - Does this match the task scope? (check PR title/body for task ID)
            - Code quality, bugs, security
            - Test coverage

            If issues found:
              - Submit a GitHub review with state CHANGES_REQUESTED
              - Be specific about what needs fixing

            If clean:
              - Submit a GitHub review with state APPROVED
              - Comment "LGTM - ready for merge"
          claude_args: '--allowed-tools "Bash(gh pr review:*),Bash(gh pr view:*),Bash(gh pr diff:*)"'

      - name: Check review state
        id: check-state
        run: |
          state=$(gh pr view $PR_NUMBER --json reviews -q '.reviews | sort_by(.submittedAt) | last | .state // "PENDING"')
          echo "state=$state" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  iterate:
    needs: review
    if: |
      needs.review.outputs.review_state == 'CHANGES_REQUESTED' &&
      fromJSON(needs.review.outputs.iteration_count) < 3
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Increment iteration count
        id: increment
        run: |
          current=${{ needs.review.outputs.iteration_count }}
          new=$((current + 1))
          echo "new_count=$new" >> $GITHUB_OUTPUT

          body=$(gh pr view $PR_NUMBER --json body -q '.body')
          if echo "$body" | grep -q '<!-- iteration-count:'; then
            new_body=$(echo "$body" | sed "s/<!-- iteration-count: [0-9]* -->/<!-- iteration-count: $new -->/")
          else
            new_body="$body"$'\n'"<!-- iteration-count: $new -->"
          fi
          gh pr edit $PR_NUMBER --body "$new_body"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get review feedback
        id: feedback
        run: |
          FEEDBACK=$(gh pr view $PR_NUMBER --json reviews -q '.reviews | sort_by(.submittedAt) | last | .body')
          echo "feedback<<EOF" >> $GITHUB_OUTPUT
          echo "$FEEDBACK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude fixes issues
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Address this review feedback for PR #${{ env.PR_NUMBER }}:

            ${{ steps.feedback.outputs.feedback }}

            Make minimal changes to fix the issues.
            Commit with message: "fix: address review feedback (iteration ${{ steps.increment.outputs.new_count }})"
            Push to this branch.
          claude_args: '--allowed-tools "Bash(git:*),Bash(gh pr:*),Read,Write,Edit"'

      - name: Trigger re-review
        run: gh workflow run pr-pipeline.yml -f pr_number=$PR_NUMBER
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  critic:
    needs: review
    if: fromJSON(needs.review.outputs.iteration_count) >= 3
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Critic evaluation
        id: critic
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are the CRITIC. Review PR #${{ env.PR_NUMBER }}.

            First, gather the PR history:
            gh pr view ${{ env.PR_NUMBER }} --json body,comments,reviews

            VETO if ANY of these apply:
            1. Scope creep: PR does more than the original task
            2. Failed iterations: 3+ rounds without resolving issues
            3. Security/architectural concerns
            4. Persistent test failures
            5. Suboptimal approach that should be reconsidered

            If VETO:
              gh pr comment ${{ env.PR_NUMBER }} --body "**CRITIC VETO**: [your rationale]"
              gh pr close ${{ env.PR_NUMBER }}

            If APPROVE:
              gh pr comment ${{ env.PR_NUMBER }} --body "**CRITIC APPROVED**: Ready for merge after 3 iterations"
              gh pr edit ${{ env.PR_NUMBER }} --add-label "critic-approved"
          claude_args: '--allowed-tools "Bash(gh pr:*)"'

  merge:
    needs: [review, wait-for-ci, critic]
    if: |
      always() &&
      needs.wait-for-ci.result == 'success' &&
      (needs.review.outputs.review_state == 'APPROVED' ||
       (needs.critic.result == 'success' && fromJSON(needs.review.outputs.iteration_count) >= 3)) &&
      contains(github.event.pull_request.labels.*.name, 'polecat')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Verify and merge
        run: |
          failed=$(gh pr checks $PR_NUMBER --json state -q '[.[] | select(.state == "FAILURE")] | length')
          if [[ "$failed" -gt 0 ]]; then exit 1; fi
          gh pr merge $PR_NUMBER --squash --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
