name: Test Setup Script

on:
  pull_request:
    paths:
      - "scripts/setup.sh"
      - "config/**"
      - "agents/**"
      - "skills/**"
      - "commands/**"
      - "hooks/**"
      - ".github/workflows/test-setup.yml"
  push:
    branches:
      - main
    paths:
      - "scripts/setup.sh"
      - "config/**"
      - "agents/**"
      - "skills/**"
      - "commands/**"
      - "hooks/**"
      - ".github/workflows/test-setup.yml"

jobs:
  test-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          bash scripts/setup.sh

      - name: Verify global ~/.claude symlinks
        run: |
          echo "Checking ~/.claude/ installation..."
          
          # Check that ~/.claude exists
          if [ ! -d "$HOME/.claude" ]; then
            echo "ERROR: ~/.claude directory not created"
            exit 1
          fi
          echo "✓ ~/.claude/ exists"
          
          # Check settings.json symlink
          if [ ! -L "$HOME/.claude/settings.json" ]; then
            echo "ERROR: ~/.claude/settings.json is not a symlink"
            exit 1
          fi
          echo "✓ ~/.claude/settings.json is a symlink"
          
          # Check CLAUDE.md symlink
          if [ ! -L "$HOME/.claude/CLAUDE.md" ]; then
            echo "ERROR: ~/.claude/CLAUDE.md is not a symlink"
            exit 1
          fi
          echo "✓ ~/.claude/CLAUDE.md is a symlink"
          
          # Check hooks directory symlink
          if [ ! -L "$HOME/.claude/hooks" ]; then
            echo "ERROR: ~/.claude/hooks is not a symlink"
            exit 1
          fi
          echo "✓ ~/.claude/hooks/ is a symlink"
          
          # Check agents directory symlink
          if [ ! -L "$HOME/.claude/agents" ]; then
            echo "ERROR: ~/.claude/agents is not a symlink"
            exit 1
          fi
          echo "✓ ~/.claude/agents/ is a symlink"
          
          # Check skills directory symlink
          if [ ! -L "$HOME/.claude/skills" ]; then
            echo "ERROR: ~/.claude/skills is not a symlink"
            exit 1
          fi
          echo "✓ ~/.claude/skills/ is a symlink"
          
          # Check commands directory symlink
          if [ ! -L "$HOME/.claude/commands" ]; then
            echo "ERROR: ~/.claude/commands is not a symlink"
            exit 1
          fi
          echo "✓ ~/.claude/commands/ is a symlink"

      - name: Verify repository .claude symlinks
        run: |
          echo "Checking .claude/ in repository..."
          
          # Check that .claude exists in repo
          if [ ! -d ".claude" ]; then
            echo "ERROR: .claude directory not created in repository"
            exit 1
          fi
          echo "✓ .claude/ exists in repository"
          
          # Check settings.json symlink (relative)
          if [ ! -L ".claude/settings.json" ]; then
            echo "ERROR: .claude/settings.json is not a symlink"
            exit 1
          fi
          # Verify it's a relative symlink
          LINK_TARGET=$(readlink .claude/settings.json)
          if [[ "$LINK_TARGET" == /* ]]; then
            echo "ERROR: .claude/settings.json is not a relative symlink (target: $LINK_TARGET)"
            exit 1
          fi
          echo "✓ .claude/settings.json is a relative symlink"
          
          # Check CLAUDE.md symlink (relative)
          if [ ! -L ".claude/CLAUDE.md" ]; then
            echo "ERROR: .claude/CLAUDE.md is not a symlink"
            exit 1
          fi
          LINK_TARGET=$(readlink .claude/CLAUDE.md)
          if [[ "$LINK_TARGET" == /* ]]; then
            echo "ERROR: .claude/CLAUDE.md is not a relative symlink (target: $LINK_TARGET)"
            exit 1
          fi
          echo "✓ .claude/CLAUDE.md is a relative symlink"
          
          # Check hooks directory symlink (relative)
          if [ ! -L ".claude/hooks" ]; then
            echo "ERROR: .claude/hooks is not a symlink"
            exit 1
          fi
          LINK_TARGET=$(readlink .claude/hooks)
          if [[ "$LINK_TARGET" == /* ]]; then
            echo "ERROR: .claude/hooks is not a relative symlink (target: $LINK_TARGET)"
            exit 1
          fi
          echo "✓ .claude/hooks/ is a relative symlink"
          
          # Check agents directory symlink (relative)
          if [ ! -L ".claude/agents" ]; then
            echo "ERROR: .claude/agents is not a symlink"
            exit 1
          fi
          LINK_TARGET=$(readlink .claude/agents)
          if [[ "$LINK_TARGET" == /* ]]; then
            echo "ERROR: .claude/agents is not a relative symlink (target: $LINK_TARGET)"
            exit 1
          fi
          echo "✓ .claude/agents/ is a relative symlink"
          
          # Check skills directory symlink (relative)
          if [ ! -L ".claude/skills" ]; then
            echo "ERROR: .claude/skills is not a symlink"
            exit 1
          fi
          LINK_TARGET=$(readlink .claude/skills)
          if [[ "$LINK_TARGET" == /* ]]; then
            echo "ERROR: .claude/skills is not a relative symlink (target: $LINK_TARGET)"
            exit 1
          fi
          echo "✓ .claude/skills/ is a relative symlink"
          
          # Check commands directory symlink (relative)
          if [ ! -L ".claude/commands" ]; then
            echo "ERROR: .claude/commands is not a symlink"
            exit 1
          fi
          LINK_TARGET=$(readlink .claude/commands)
          if [[ "$LINK_TARGET" == /* ]]; then
            echo "ERROR: .claude/commands is not a relative symlink (target: $LINK_TARGET)"
            exit 1
          fi
          echo "✓ .claude/commands/ is a relative symlink"

      - name: Verify symlink targets exist
        run: |
          echo "Verifying that symlink targets are accessible..."
          
          # Test ~/.claude symlinks point to valid files
          if [ ! -f "$HOME/.claude/settings.json" ]; then
            echo "ERROR: ~/.claude/settings.json target does not exist or is not accessible"
            exit 1
          fi
          echo "✓ ~/.claude/settings.json target is accessible"
          
          if [ ! -f "$HOME/.claude/CLAUDE.md" ]; then
            echo "ERROR: ~/.claude/CLAUDE.md target does not exist or is not accessible"
            exit 1
          fi
          echo "✓ ~/.claude/CLAUDE.md target is accessible"
          
          # Test .claude symlinks point to valid files
          if [ ! -f ".claude/settings.json" ]; then
            echo "ERROR: .claude/settings.json target does not exist or is not accessible"
            exit 1
          fi
          echo "✓ .claude/settings.json target is accessible"
          
          if [ ! -f ".claude/CLAUDE.md" ]; then
            echo "ERROR: .claude/CLAUDE.md target does not exist or is not accessible"
            exit 1
          fi
          echo "✓ .claude/CLAUDE.md target is accessible"
          
          echo "All symlinks verified successfully!"
