#!/bin/bash
################################################################################
# Pre-commit hook: Prevent documentation file proliferation
################################################################################
#
# PURPOSE:
#   Enforces the documentation philosophy across the entire repository:
#   - Scripts should be self-documenting (--help, inline comments)
#   - Processes should use issue templates (not HOWTO docs)
#   - README files are generally forbidden (with rare exceptions)
#
# WHAT IT BLOCKS:
#   - New .md files anywhere (except allowed paths)
#   - README.md, HOWTO.md, GUIDE.md anywhere
#   - System documentation in any directory
#
# WHAT IT ALLOWS:
#   - Research papers and manuscripts (papers/ directory)
#   - Agent instruction files (bot/agents/*.md - these ARE executable code)
#   - Actual project deliverables (the work product itself)
#
# HOW TO OVERRIDE:
#   Answer 'y' when prompted if the file truly is:
#   - A research manuscript or paper
#   - An agent instruction (executable code)
#   - A project deliverable (not system documentation)
#
################################################################################

# Get list of ALL new .md files being added (status A)
all_new_md=$(git diff --cached --name-status --diff-filter=A | grep -E '^\s*A\s+.*\.md$' | awk '{print $2}')

if [ -z "$all_new_md" ]; then
    # No new .md files, exit cleanly
    exit 0
fi

# Filter OUT allowed paths (these are legitimate .md files)
# Allowed:
#   - bot/agents/*.md (agent instructions are executable code)
#   - papers/**/*.md (research content)
#   - projects/*/papers/**/*.md (project research content)
#   - projects/*/manuscripts/**/*.md (manuscript drafts)
#
# Everything else requires confirmation

forbidden_files=""
while IFS= read -r file; do
    # Skip empty lines
    [ -z "$file" ] && continue

    # Allow agent instructions (these ARE the code)
    if [[ "$file" =~ ^bot/agents/.*\.md$ ]]; then
        continue
    fi

    # Allow research papers
    if [[ "$file" =~ ^papers/.*\.md$ ]]; then
        continue
    fi

    # Allow project manuscripts and papers
    if [[ "$file" =~ ^projects/[^/]+/(papers|manuscripts)/.*\.md$ ]]; then
        continue
    fi

    # Everything else is potentially forbidden
    forbidden_files="${forbidden_files}${file}"$'\n'
done <<< "$all_new_md"

# If we found potentially forbidden files, require confirmation
if [ -n "$forbidden_files" ]; then
    echo ""
    echo "üõë WARNING: New .md file(s) detected that may violate documentation philosophy:"
    echo ""
    echo "$forbidden_files" | while IFS= read -r file; do
        [ -z "$file" ] && continue
        echo "  - $file"
    done
    echo ""
    echo "Documentation Philosophy:"
    echo "  ‚úÖ ALLOWED: Research papers, manuscripts, agent instructions (bot/agents/)"
    echo "  ‚ùå FORBIDDEN: README.md, HOWTO.md, GUIDE.md, system documentation"
    echo ""
    echo "Instead of creating documentation files, use:"
    echo "  ‚Ä¢ Scripts with --help output and comprehensive inline comments"
    echo "  ‚Ä¢ Issue templates with complete instructions"
    echo "  ‚Ä¢ Thorough commit messages explaining the 'why'"
    echo "  ‚Ä¢ GitHub issues for tracking and decisions"
    echo "  ‚Ä¢ Code comments for design decisions"
    echo ""
    echo "Only proceed if these files are:"
    echo "  ‚Ä¢ Research manuscripts or papers (actual work product)"
    echo "  ‚Ä¢ Agent instructions (executable behavior definitions)"
    echo "  ‚Ä¢ Project deliverables (not system documentation)"
    echo ""
    read -p "Are you CERTAIN these are allowed content types? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚úã Commit aborted."
        echo ""
        echo "To unstage files: git reset HEAD <file>"
        echo "To delete files: rm <file>"
        echo ""
        echo "Consider instead:"
        echo "  ‚Ä¢ Adding --help to your script"
        echo "  ‚Ä¢ Creating an issue template"
        echo "  ‚Ä¢ Writing inline code comments"
        exit 1
    fi
    echo "‚ö†Ô∏è  Proceeding with commit (user confirmed)..."
fi

exit 0
